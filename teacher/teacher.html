<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFlow - Teacher Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --brand-blue: #3B82F6; }
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .mobile-container { max-width: 420px; min-height: 100vh; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to: { opacity: 1; } }
        .attendance-present { background-color: #DCFCE7; color: #166534; }
        .attendance-absent { background-color: #FEE2E2; color: #991B1B; }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1jyfjfNrBAKSIFPFF5rgZEwzlJeLoqjA",
            authDomain: "qwerty1-6fc97.firebaseapp.com",
            databaseURL: "https://qwerty1-6fc97-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qwerty1-6fc97",
            storageBucket: "qwerty1-6fc97.appspot.com",
            messagingSenderId: "334235813327",
            appId: "1:334235813327:web:95d7e601403f60f0413eba",
            measurementId: "G-C4W4SC89NH"
        };

        // Initialize Firebase
        let database;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            } else {
                firebase.app();
            }
            database = firebase.database();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Utility functions
        const formatDate = (dateString) => {
            if (!dateString) return 'None';
            try {
                if (new Date(dateString).toString() === 'Invalid Date') return dateString;
                const options = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Kolkata' };
                return new Date(dateString).toLocaleDateString('en-US', options);
            } catch (e) {
                return dateString;
            }
        };

        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Firebase database READ function
        const fetchFromFirebase = async (path) => {
            try {
                const fullPath = path;
                console.log(`Fetching from Firebase: ${fullPath}`);
                const snapshot = await database.ref(fullPath).once('value');
                const data = snapshot.val();
                console.log(`Firebase data received for ${fullPath}:`, data);
                return data;
            } catch (error) {
                console.error('Error fetching from Firebase:', error);
                return null;
            }
        };
        
        // Firebase database WRITE function
        const writeToFirebase = async (path, data) => {
            try {
                console.log(`Writing to Firebase: ${path}`, data);
                await database.ref(path).set(data);
                console.log("Write successful");
                return true;
            } catch (error) {
                console.error('Error writing to Firebase:', error);
                return false;
            }
        };

        //==================================
        // Reusable Components
        //==================================
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center py-4">
                <i data-lucide="loader" className="w-6 h-6 text-blue-600 loading-spinner"></i>
            </div>
        );

        const PageHeader = ({ title, onBack, showBackButton = true, rightAction }) => (
            <header className="flex items-center p-4 shadow-md" style={{ backgroundColor: 'var(--brand-blue)' }}>
                {showBackButton && (
                    <a href="#" onClick={(e) => { e.preventDefault(); onBack(); }} className="text-white">
                        <i data-lucide="arrow-left"></i>
                    </a>
                )}
                <h1 className="text-white text-xl font-bold ml-4 flex-1">{title}</h1>
                {rightAction && rightAction}
            </header>
        );

        const StatCard = ({ label, value, color, icon }) => (
            <div className={`bg-${color}-100 p-4 rounded-lg text-center`}>
                {icon && <i data-lucide={icon} className={`w-6 h-6 mx-auto mb-2 text-${color}-600`}></i>}
                <p className={`text-sm text-${color}-800`}>{label}</p>
                <p className={`text-2xl font-bold text-${color}-900`}>{value}</p>
            </div>
        );

        const AnnouncementCard = ({ title, content, date, target }) => (
            <div className="bg-white p-4 rounded-lg shadow-sm border fade-in">
                <div className="flex justify-between items-start">
                    <h4 className="font-semibold text-gray-800">{title}</h4>
                    {target && target !== 'all' && (
                        <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">{target}</span>
                    )}
                </div>
                <p className="text-sm text-gray-600 mt-1">{content}</p>
                <p className="text-xs text-gray-400 mt-2">{formatDate(date)}</p>
            </div>
        );

        //==================================
        // Reusable Footer Component
        //==================================
        const AppFooter = ({ activePage, onNavigate }) => {
            useEffect(() => { 
                if (window.lucide) {
                    lucide.createIcons(); 
                }
            }, [activePage]);
            
            const navItems = [ 
                { id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard' }, 
                { id: 'classes', icon: 'users', label: 'Classes' },
                { id: 'attendance', icon: 'user-check', label: 'Attendance' }, 
                { id: 'homework', icon: 'notebook-pen', label: 'Homework' },
                { id: 'timetable', icon: 'calendar', label: 'Timetable' }
            ];
            
            return ( 
                <footer className="grid grid-cols-5 gap-1 p-2 border-t bg-white sticky bottom-0"> 
                    {navItems.map(item => { 
                        const isActive = activePage === item.id; 
                        return ( 
                            <a 
                                href="#" 
                                key={item.id} 
                                onClick={(e) => { e.preventDefault(); onNavigate(item.id); }} 
                                className={`flex flex-col items-center p-2 rounded-lg ${isActive ? 'text-blue-600' : 'text-gray-500 hover:text-blue-600'}`}
                            > 
                                <i data-lucide={item.icon} className="w-5 h-5"></i>
                                <span className="text-xs mt-1">{item.label}</span> 
                            </a> 
                        ); 
                    })} 
                </footer> 
            );
        };

        //==================================
        // TEACHER DASHBOARD PAGE COMPONENT
        //==================================
        const DashboardPage = ({ onNavigate, currentPage }) => {
            const [dashboardStats, setDashboardStats] = useState([
                { label: 'My Classes', value: '...', color: 'blue', icon: 'users' },
                { label: 'Students', value: '...', color: 'green', icon: 'user-check' },
                { label: 'Pending Tasks', value: '...', color: 'yellow', icon: 'clipboard-list' },
                { label: 'Today\'s Classes', value: '...', color: 'red', icon: 'calendar' }
            ]);
            const [announcements, setAnnouncements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [teacherName, setTeacherName] = useState('Teacher');
            const teacherId = localStorage.getItem('teacherId') || 'T001';

            useEffect(() => {
                fetchDashboardData();
            }, []);

            const fetchDashboardData = async () => {
                try {
                    setLoading(true);
                    
                    const teacherData = await fetchFromFirebase(`teachers/${teacherId}`);
                    console.log("Teacher data in dashboard:", teacherData);
                    
                    if (teacherData && teacherData.name) {
                        setTeacherName(teacherData.name);
                        localStorage.setItem('loggedInUserName', teacherData.name);
                    } else {
                        const storedName = localStorage.getItem('loggedInUserName');
                        if (storedName) {
                            setTeacherName(storedName);
                        }
                    }
                    
                    const announcementsData = await fetchFromFirebase('announcements/announcements');
                    const allAnnouncements = announcementsData || [];
                    
                    const filteredAnnouncements = allAnnouncements.filter(ann => 
                        ann.target_audience === 'all' || ann.target_audience === 'teachers'
                    ).slice(0, 3);
                    
                    setAnnouncements(filteredAnnouncements);

                    const teacherClasses = teacherData?.classes || [];
                    
                    let totalStudents = 0;
                    let todaysClasses = 0;
                    let pendingTasks = 0;
                    
                    const allStudents = await fetchFromFirebase('students');

                    for (const classCode of teacherClasses) {
                        const classData = await fetchFromFirebase(`classes/${classCode}`);
                        if (classData) {
                            if (allStudents) {
                                totalStudents += Object.values(allStudents).filter(s => s.class === classCode).length;
                            }
                            
                            if (classData.timetable) {
                                const dayOfWeek = new Date().getDay(); // 0-6
                                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                                const todayKey = days[dayOfWeek];
                                if(classData.timetable[todayKey]) {
                                    todaysClasses += classData.timetable[todayKey].length;
                                }
                            }
                            
                            if (classData.homework) {
                                const homeworkArray = Object.values(classData.homework);
                                pendingTasks += homeworkArray.filter(h => new Date(h.due_date) <= new Date()).length;
                            }
                        }
                    }

                    const updatedStats = [
                        { label: 'My Classes', value: teacherClasses.length, color: 'blue', icon: 'users' },
                        { label: 'Students', value: totalStudents, color: 'green', icon: 'user-check' },
                        { label: 'Pending Tasks', value: pendingTasks, color: 'yellow', icon: 'clipboard-list' },
                        { label: 'Today\'s Classes', value: todaysClasses, color: 'red', icon: 'calendar' }
                    ];

                    setDashboardStats(updatedStats);
                } catch (error) {
                    console.error('Error fetching dashboard data:', error);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    <header className="flex items-center justify-between p-4 shadow-md" style={{ backgroundColor: 'var(--brand-blue)' }}>
                        <a href="#" onClick={(e) => { e.preventDefault(); onNavigate('profile'); }} className="text-white">
                            <i data-lucide="user-circle"></i>
                        </a>
                        <h1 className="text-white text-xl font-bold">Dashboard</h1>
                        <div className="w-6"></div>
                    </header>
                    <main className="flex-1 p-6 overflow-y-auto bg-gray-50">
                        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg mb-6">
                            <h2 className="text-xl font-bold">Good morning, {teacherName}!</h2>
                            <p className="text-sm opacity-90">{new Date().toLocaleDateString('en-US', { 
                                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Kolkata' 
                            })}</p>
                        </div>
                        
                        <h3 className="text-lg font-semibold text-gray-700 mb-3">Your Overview</h3>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            {dashboardStats.map(stat => <StatCard key={stat.label} {...stat} />)}
                        </div>
                        
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="text-lg font-semibold text-gray-700">Recent Announcements</h3>
                        </div>
                        <div className="space-y-3">
                            {loading ? <LoadingSpinner /> : announcements.length > 0 ? (
                                announcements.map(item => (
                                    <AnnouncementCard 
                                        key={item.id} 
                                        title={item.title} 
                                        content={item.content} 
                                        date={item.created_at}
                                        target={item.target_audience}
                                    />
                                ))
                            ) : (
                                <div className="text-center py-4 text-gray-500">No announcements found</div>
                            )}
                        </div>
                    </main>
                    <AppFooter activePage={currentPage} onNavigate={onNavigate} />
                </div>
            );
        };

        //==================================
        // TEACHER PROFILE PAGE COMPONENT
        //==================================
        const ProfilePage = ({ onNavigate }) => {
            const [teacherData, setTeacherData] = useState(null);
            const [loading, setLoading] = useState(true);

            // FIX: Ensure icons render when profile page loads
            useEffect(() => {
                if (window.lucide) {
                    lucide.createIcons();
                }
            }, [teacherData, loading]);

            useEffect(() => {
                fetchTeacherData();
            }, []);

            const fetchTeacherData = async () => {
                try {
                    setLoading(true);
                    const teacherId = localStorage.getItem('teacherId') || 'T001';
                    const data = await fetchFromFirebase(`teachers/${teacherId}`);
                    setTeacherData(data);
                    
                    if (data && !localStorage.getItem('loggedInUserName')) {
                        localStorage.setItem('loggedInUserName', data.name);
                        localStorage.setItem('loggedInUserEmail', data.email);
                    }
                } catch (error) {
                    console.error('Error fetching teacher data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.clear();
                    window.location.href = 'index.html';
                }
            };

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    <PageHeader title="My Profile" onBack={() => onNavigate('dashboard')} />
                    <main className="flex-1 p-6 overflow-y-auto bg-gray-50">
                        {loading ? (
                            <LoadingSpinner />
                        ) : teacherData ? (
                            <>
                                <div className="bg-white rounded-xl shadow-sm p-6 mb-6 text-center border">
                                    <i data-lucide="user-circle" className="w-24 h-24 mx-auto mb-4 text-gray-300"></i>
                                    <h2 className="text-2xl font-bold text-gray-800">{teacherData.name || 'None'}</h2>
                                    <p className="text-gray-500">Teacher - {teacherData.subject || 'N/A'}</p>
                                </div>
                                <div className="bg-white rounded-xl shadow-sm p-6 border text-gray-800">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-500">Teacher ID</label>
                                            <p className="font-semibold">{localStorage.getItem('teacherId') || 'None'}</p>
                                        </div>
                                        <div className="border-t"></div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-500">Email</label>
                                            <p className="font-semibold">{teacherData.email || 'None'}</p>
                                        </div>
                                        <div className="border-t"></div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-500">Subject</label>
                                            <p className="font-semibold">{teacherData.subject || 'None'}</p>
                                        </div>
                                        <div className="border-t"></div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-500">Classes</label>
                                            <p className="font-semibold">{teacherData.classes ? teacherData.classes.join(', ') : 'None'}</p>
                                        </div>
                                        {teacherData.phone && (
                                            <>
                                                <div className="border-t"></div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-500">Phone</label>
                                                    <p className="font-semibold">{teacherData.phone}</p>
                                                </div>
                                            </>
                                        )}
                                        {teacherData.address && (
                                            <>
                                                <div className="border-t"></div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-500">Address</label>
                                                    <p className="font-semibold">{teacherData.address}</p>
                                                </div>
                                            </>
                                        )}
                                        {teacherData.qualification && (
                                            <>
                                                <div className="border-t"></div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-500">Qualification</label>
                                                    <p className="font-semibold">{teacherData.qualification}</p>
                                                </div>
                                            </>
                                        )}
                                        {teacherData.dateOfBirth && (
                                            <>
                                                <div className="border-t"></div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-500">Date of Birth</label>
                                                    <p className="font-semibold">{formatDate(teacherData.dateOfBirth)}</p>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <button onClick={handleLogout} className="w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg flex items-center justify-center">
                                    <i data-lucide="log-out" className="w-5 h-5 mr-2"></i> Logout
                                </button>
                            </>
                        ) : (
                            <div className="text-center py-6 text-gray-500">
                                <i data-lucide="user-x" className="w-12 h-12 mx-auto text-gray-400"></i>
                                <p className="mt-2">Teacher data not found.</p>
                                <p className="text-sm">Teacher ID: {localStorage.getItem('teacherId') || 'T001'}</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        //==================================
        // MY CLASSES PAGE COMPONENT
        //==================================
        const ClassesPage = ({ onNavigate, currentPage }) => {
            const [classes, setClasses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [allStudents, setAllStudents] = useState({});

            useEffect(() => {
                fetchClasses();
            }, []);

            const fetchClasses = async () => {
                try {
                    setLoading(true);
                    const teacherId = localStorage.getItem('teacherId') || 'T001';
                    const teacherData = await fetchFromFirebase(`teachers/${teacherId}`);
                    const studentsData = await fetchFromFirebase('students');
                    setAllStudents(studentsData || {});
                    
                    if (!teacherData || !teacherData.classes) {
                        setClasses([]);
                        return;
                    }
                    
                    const classDetails = [];
                    for (const classCode of teacherData.classes) {
                        const classData = await fetchFromFirebase(`classes/${classCode}`);
                        if (classData) {
                            classDetails.push({
                                code: classCode,
                                ...classData
                            });
                        }
                    }
                    
                    setClasses(classDetails);
                } catch (error) {
                    console.error('Error fetching classes:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            const getStudentCount = (classCode) => {
                return Object.values(allStudents).filter(s => s.class === classCode).length;
            };

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    <PageHeader title="My Classes" onBack={() => onNavigate('dashboard')} />
                    <main className="flex-1 p-6 overflow-y-auto bg-gray-50">
                        {loading ? (
                            <LoadingSpinner />
                        ) : classes.length > 0 ? (
                            <div className="space-y-4">
                                {classes.map(classItem => (
                                    <a 
                                        href="#"
                                        key={classItem.code} 
                                        onClick={(e) => { e.preventDefault(); onNavigate('classRoster', { classCode: classItem.code }); }}
                                        className="bg-white p-4 rounded-lg border fade-in block hover:bg-gray-50"
                                    >
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="font-bold text-gray-800 text-lg">Class {classItem.code}</h3>
                                            <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                                                {getStudentCount(classItem.code)} Students
                                            </span>
                                        </div>
                                        <div className="flex space-x-2">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onNavigate('attendance', { classCode: classItem.code }); }}
                                                className="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded flex items-center justify-center"
                                            >
                                                <i data-lucide="user-check" className="w-4 h-4 mr-1"></i> Attendance
                                            </button>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onNavigate('homework', { classCode: classItem.code }); }}
                                                className="flex-1 bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-3 rounded flex items-center justify-center"
                                            >
                                                <i data-lucide="notebook-pen" className="w-4 h-4 mr-1"></i> Homework
                                            </button>
                                        </div>
                                    </a>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-6 text-gray-500">
                                <i data-lucide="users" className="w-12 h-12 mx-auto text-gray-400"></i>
                                <p className="mt-2">No classes assigned.</p>
                            </div>
                        )}
                    </main>
                    <AppFooter activePage={currentPage} onNavigate={onNavigate} />
                </div>
            );
        };
        
        //==================================
        // CLASS ROSTER PAGE
        //==================================
        const ClassRosterPage = ({ onNavigate, classCode }) => {
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchRoster();
            }, [classCode]);

            const fetchRoster = async () => {
                try {
                    setLoading(true);
                    const allStudents = await fetchFromFirebase('students');
                    if (allStudents) {
                        const classStudents = Object.values(allStudents)
                            .filter(s => s.class === classCode)
                            .sort((a, b) => a.rollNo - b.rollNo);
                        setStudents(classStudents);
                    }
                } catch (error) {
                    console.error("Error fetching roster:", error);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    <PageHeader title={`Class ${classCode} Roster`} onBack={() => onNavigate('classes')} />
                    <main className="flex-1 overflow-y-auto bg-gray-50">
                        {loading ? (
                            <LoadingSpinner />
                        ) : students.length > 0 ? (
                            <div className="bg-white rounded-lg shadow-sm border m-4 overflow-hidden">
                                <ul className="divide-y divide-gray-200">
                                    {students.map(student => (
                                        <li key={student.admission_number} className="p-4 flex items-center">
                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                                <span className="font-semibold text-gray-600">{student.rollNo}</span>
                                            </div>
                                            <div>
                                                <p className="font-medium text-gray-800">{student.name}</p>
                                                <p className="text-sm text-gray-500">{student.admission_number}</p>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ) : (
                            <div className="text-center py-6 text-gray-500">
                                <i data-lucide="user-x" className="w-12 h-12 mx-auto text-gray-400"></i>
                                <p className="mt-2">No students found in this class.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };


        //==================================
        // ATTENDANCE PAGE COMPONENT
        //==================================
        const AttendancePage = ({ onNavigate, currentPage, classCode: initialClassCode }) => {
            const [classes, setClasses] = useState([]);
            const [selectedClass, setSelectedClass] = useState(initialClassCode || '');
            const [attendance, setAttendance] = useState([]);
            const [loading, setLoading] = useState(true);
            const [allStudents, setAllStudents] = useState({});

            useEffect(() => {
                fetchTeacherClasses();
            }, []);

            const fetchTeacherClasses = async () => {
                try {
                    setLoading(true);
                    const teacherId = localStorage.getItem('teacherId') || 'T001';
                    const teacherData = await fetchFromFirebase(`teachers/${teacherId}`);
                    const studentsData = await fetchFromFirebase('students');
                    setAllStudents(studentsData || {});
                    
                    if (teacherData && teacherData.classes) {
                        const teacherClasses = teacherData.classes;
                        setClasses(teacherClasses);
                        
                        let classToLoad = selectedClass;
                        if (!classToLoad && teacherClasses.length > 0) {
                            classToLoad = teacherClasses[0];
                            setSelectedClass(classToLoad);
                        }
                        
                        if (classToLoad) {
                            await fetchClassAttendance(classToLoad);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching teacher classes:', error);
                } finally {
                    setLoading(false);
                }
            };

            const fetchClassAttendance = async (classCode) => {
                try {
                    setLoading(true);
                    const classData = await fetchFromFirebase(`classes/${classCode}`) || {};
                    const attendanceArray = Object.values(classData.attendance || {});
                    
                    if (attendanceArray.length === 0) {
                        setAttendance([]);
                        return;
                    }
                    
                    const recentAttendance = attendanceArray
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 10);
                    
                    setAttendance(recentAttendance);
                } catch (error) {
                    console.error('Error fetching attendance:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            const getStudentName = (studentId) => {
                return allStudents[studentId]?.name || studentId;
            };

            const handleClassChange = (classCode) => {
                setSelectedClass(classCode);
                fetchClassAttendance(classCode);
            };

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    <PageHeader title="Attendance" onBack={() => onNavigate('dashboard')} />
                    <main className="flex-1 p-6 overflow-y-auto bg-gray-50">
                        {loading ? <LoadingSpinner /> : (
                            <>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Select Class</label>
                                    <select 
                                        value={selectedClass}
                                        onChange={(e) => handleClassChange(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg bg-white"
                                    >
                                        {classes.map(classCode => (
                                            <option key={classCode} value={classCode}>Class {classCode}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <h3 className="text-lg font-semibold text-gray-700 mb-3">Recent Attendance</h3>
                                {attendance.length > 0 ? (
                                    <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                                        <ul className="divide-y divide-gray-200">
                                            {attendance.map(record => (
                                                <li key={record.id} className="p-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <p className="font-medium text-gray-800">{formatDate(record.date)}</p>
                                                        <span className={`text-sm font-semibold px-3 py-1 rounded-full ${
                                                            record.status === 'present' ? 'attendance-present' : 'attendance-absent'
                                                        }`}>
                                                            {record.status === 'present' ? 'Present' : 'Absent'}
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-gray-500">Student: {getStudentName(record.student_id)}</p>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ) : (
                                    <div className="text-center py-6 text-gray-500">
                                        <i data-lucide="calendar-x" className="w-12 h-12 mx-auto text-gray-400"></i>
                                        <p className="mt-2">No attendance records found.</p>
                                    </div>
                                )}
                                
                                <button 
                                    onClick={() => onNavigate('markAttendance', { classCode: selectedClass })}
                                    disabled={!selectedClass}
                                    className="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-lg flex items-center justify-center disabled:bg-gray-400"
                                >
                                    <i data-lucide="plus" className="w-5 h-5 mr-2"></i> Mark Today's Attendance
                                </button>
                            </>
                        )}
                    </main>
                    <AppFooter activePage={currentPage} onNavigate={onNavigate} />
                </div>
            );
        };
        
        //==================================
        // MARK ATTENDANCE PAGE
        //==================================
        const MarkAttendancePage = ({ onNavigate, classCode }) => {
            const [students, setStudents] = useState([]);
            const [attendanceStatus, setAttendanceStatus] = useState({});
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const todayDate = getTodayDateString();

            useEffect(() => {
                fetchStudentsAndAttendance();
            }, [classCode]);

            const fetchStudentsAndAttendance = async () => {
                try {
                    setLoading(true);
                    const allStudents = await fetchFromFirebase('students');
                    const classData = await fetchFromFirebase(`classes/${classCode}`);
                    
                    const classStudents = Object.values(allStudents || {})
                        .filter(s => s.class === classCode)
                        .sort((a, b) => a.rollNo - b.rollNo);
                    setStudents(classStudents);
                    
                    const existingAttendance = Object.values(classData?.attendance || {});
                    const todaysAttendance = existingAttendance.filter(a => a.date === todayDate);
                    
                    const initialStatus = {};
                    classStudents.forEach(student => {
                        const record = todaysAttendance.find(a => a.student_id === student.admission_number);
                        initialStatus[student.admission_number] = record ? record.status : 'present';
                    });
                    setAttendanceStatus(initialStatus);
                    
                } catch (error) {
                    console.error("Error fetching students:", error);
                } finally {
                    setLoading(false);
                }
            };

            const setStatus = (studentId, status) => {
                setAttendanceStatus(prev => ({ ...prev, [studentId]: status }));
            };

            const handleSubmit = async () => {
                if (confirm('Are you sure you want to submit this attendance?')) {
                    try {
                        setIsSubmitting(true);
                        const classData = await fetchFromFirebase(`classes/${classCode}`);
                        const attendanceNode = classData?.attendance || {};
                        
                        const newAttendanceRecords = {};
                        students.forEach(student => {
                            const recordId = `ATT-${todayDate}-${student.admission_number}`;
                            newAttendanceRecords[recordId] = {
                                id: recordId,
                                date: todayDate,
                                student_id: student.admission_number,
                                status: attendanceStatus[student.admission_number] || 'present'
                            };
                        });
                        
                        const updatedAttendance = {...attendanceNode, ...newAttendanceRecords};
                        await writeToFirebase(`classes/${classCode}/attendance`, updatedAttendance);
                        
                        alert('Attendance submitted successfully!');
                        onNavigate('attendance');
                    } catch (error) {
                        console.error("Error submitting attendance:", error);
                        alert('Failed to submit attendance.');
                    } finally {
                        setIsSubmitting(false);
                    }
                }
            };

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    <PageHeader title={`Mark Attendance - ${classCode}`} onBack={() => onNavigate('attendance')} />
                    <main className="flex-1 p-6 overflow-y-auto bg-gray-50">
                        {loading ? <LoadingSpinner /> : (
                            <>
                                <div className="bg-white p-4 rounded-lg border mb-4 text-center">
                                    <h3 className="font-semibold text-lg text-gray-800">Date: {formatDate(todayDate)}</h3>
                                </div>
                                <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                                    <ul className="divide-y divide-gray-200">
                                        {students.map(student => (
                                            <li key={student.admission_number} className="p-4">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <p className="font-medium text-gray-800">{student.name}</p>
                                                        <p className="text-sm text-gray-500">Roll No: {student.rollNo}</p>
                                                    </div>
                                                    <div className="flex space-x-2">
                                                        <button 
                                                            onClick={() => setStatus(student.admission_number, 'present')}
                                                            className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                                attendanceStatus[student.admission_number] === 'present' 
                                                                ? 'bg-green-600 text-white' 
                                                                : 'bg-gray-200 text-gray-700'
                                                            }`}
                                                        >
                                                            Present
                                                        </button>
                                                        <button 
                                                            onClick={() => setStatus(student.admission_number, 'absent')}
                                                            className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                                attendanceStatus[student.admission_number] === 'absent' 
                                                                ? 'bg-red-600 text-white' 
                                                                : 'bg-gray-200 text-gray-700'
                                                            }`}
                                                        >
                                                            Absent
                                                        </button>
                                                    </div>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <button
                                    onClick={handleSubmit}
                                    disabled={isSubmitting}
                                    className="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-medium py-3 rounded-lg flex items-center justify-center disabled:bg-gray-400"
                                >
                                    {isSubmitting ? (
                                        <i data-lucide="loader" className="w-5 h-5 mr-2 loading-spinner"></i>
                                    ) : (
                                        <i data-lucide="check-circle" className="w-5 h-5 mr-2"></i>
                                    )}
                                    Submit Attendance
                                </button>
                            </>
                        )}
                    </main>
                </div>
            );
        };
        
        //==================================
        // HOMEWORK MODAL COMPONENT
        //==================================
        const HomeworkModal = ({ onClose, classCode, onHomeworkAssigned }) => {
            const [subject, setSubject] = useState(localStorage.getItem('teacherSubject') || '');
            const [task, setTask] = useState('');
            const [dueDate, setDueDate] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                const savedSubject = localStorage.getItem('teacherSubject') || '';
                setSubject(savedSubject);
                
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                setDueDate(tomorrow.toISOString().split('T')[0]);
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!subject || !task || !dueDate) {
                    alert('Please fill in all fields.');
                    return;
                }
                
                try {
                    setIsSubmitting(true);
                    const classData = await fetchFromFirebase(`classes/${classCode}`);
                    const homeworkNode = classData?.homework || {};
                    
                    const hwId = 'HW' + Date.now();
                    const newHwObject = {
                        id: hwId,
                        subject: subject,
                        task: task,
                        due_date: dueDate,
                        assigned_date: getTodayDateString(),
                        assigned_by: localStorage.getItem('loggedInUserName') || 'Teacher'
                    };
                    
                    const updatedHomework = {...homeworkNode, [hwId]: newHwObject};
                    await writeToFirebase(`classes/${classCode}/homework`, updatedHomework);
                    
                    alert('Homework assigned successfully!');
                    onHomeworkAssigned();
                    
                } catch (error) {
                    console.error("Error assigning homework:", error);
                    alert('Failed to assign homework.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2 className="text-xl font-bold text-gray-800 mb-4">Assign Homework</h2>
                        <p className="text-sm text-gray-500 mb-4">For Class: <span className="font-semibold text-blue-600">{classCode}</span></p>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input 
                                    type="text"
                                    value={subject}
                                    onChange={(e) => setSubject(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    placeholder="e.g., Mathematics"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Task</label>
                                <textarea
                                    value={task}
                                    onChange={(e) => setTask(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    rows="3"
                                    placeholder="e.g., Complete exercise 5.2"
                                    required
                                ></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                <input 
                                    type="date"
                                    value={dueDate}
                                    onChange={(e) => setDueDate(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    required
                                />
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button 
                                    type="button" 
                                    onClick={onClose}
                                    className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Cancel
                                </button>
                                <button 
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 flex items-center"
                                >
                                    {isSubmitting ? (
                                        <i data-lucide="loader" className="w-5 h-5 mr-2 loading-spinner"></i>
                                    ) : (
                                        <i data-lucide="plus" className="w-5 h-5 mr-2"></i>
                                    )}
                                    Assign
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        //==================================
        // HOMEWORK PAGE COMPONENT
        //==================================
        const HomeworkPage = ({ onNavigate, currentPage, classCode: initialClassCode }) => {
            const [classes, setClasses] = useState([]);
            const [selectedClass, setSelectedClass] = useState(initialClassCode || '');
            const [homework, setHomework] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);

            useEffect(() => {
                fetchTeacherClasses();
            }, []);

            const fetchTeacherClasses = async () => {
                try {
                    setLoading(true);
                    const teacherId = localStorage.getItem('teacherId') || 'T001';
                    const teacherData = await fetchFromFirebase(`teachers/${teacherId}`);
                    
                    if (teacherData && teacherData.classes) {
                        const teacherClasses = teacherData.classes;
                        setClasses(teacherClasses);

                        let classToLoad = selectedClass;
                        if (!classToLoad && teacherClasses.length > 0) {
                            classToLoad = teacherClasses[0];
                            setSelectedClass(classToLoad);
                        }
                        
                        if (classToLoad) {
                            await fetchClassHomework(classToLoad);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching teacher classes:', error);
                } finally {
                    setLoading(false);
                }
            };

            const fetchClassHomework = async (classCode) => {
                try {
                    setLoading(true);
                    const classData = await fetchFromFirebase(`classes/${classCode}`) || {};
                    const homeworkArray = Object.values(classData.homework || {});
                    
                    if (homeworkArray.length === 0) {
                        setHomework([]);
                        return;
                    }
                    
                    const sortedHomework = homeworkArray
                        .sort((a, b) => new Date(b.assigned_date) - new Date(a.assigned_date));
                    
                    setHomework(sortedHomework);
                } catch (error) {
                    console.error('Error fetching homework:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleClassChange = (classCode) => {
                setSelectedClass(classCode);
                fetchClassHomework(classCode);
            };
            
            const handleHomeworkAssigned = () => {
                setIsModalOpen(false);
                fetchClassHomework(selectedClass);
            };

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    {isModalOpen && (
                        <HomeworkModal 
                            onClose={() => setIsModalOpen(false)}
                            classCode={selectedClass}
                            onHomeworkAssigned={handleHomeworkAssigned}
                        />
                    )}
                    <PageHeader title="Homework" onBack={() => onNavigate('dashboard')} />
                    <main className="flex-1 p-6 overflow-y-auto bg-gray-50">
                        {loading ? (
                            <LoadingSpinner />
                        ) : (
                            <>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Select Class</label>
                                    <select 
                                        value={selectedClass}
                                        onChange={(e) => handleClassChange(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg bg-white"
                                    >
                                        {classes.map(classCode => (
                                            <option key={classCode} value={classCode}>Class {classCode}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                {homework.length > 0 ? (
                                    <div className="space-y-4">
                                        {homework.map(hw => (
                                            <div key={hw.id} className="bg-white p-4 rounded-lg border fade-in">
                                                <div className="flex justify-between items-start mb-2">
                                                    <h4 className="font-semibold text-gray-800">{hw.subject}</h4>
                                                    {hw.due_date && (
                                                        <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                                                            Due: {formatDate(hw.due_date)}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-gray-700 mb-2">{hw.task}</p>
                                                <div className="flex justify-between items-center text-sm text-gray-500">
                                                    <span>Assigned: {formatDate(hw.assigned_date)}</span>
                                                    <span>{hw.assigned_by || 'You'}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-6 text-gray-500">
                                        <i data-lucide="party-popper" className="w-12 h-12 mx-auto text-green-500"></i>
                                        <p className="mt-2">No homework assigned!</p>
                                    </div>
                                )}
                                
                                <button 
                                    onClick={() => setIsModalOpen(true)}
                                    disabled={!selectedClass}
                                    className="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-medium py-3 rounded-lg flex items-center justify-center disabled:bg-gray-400"
                                >
                                    <i data-lucide="plus" className="w-5 h-5 mr-2"></i> Assign New Homework
                                </button>
                            </>
                        )}
                    </main>
                    <AppFooter activePage={currentPage} onNavigate={onNavigate} />
                </div>
            );
        };

        //==================================
        // TIMETABLE PAGE COMPONENT
        //==================================
        const TimetablePage = ({ onNavigate, currentPage }) => {
            const [timetable, setTimetable] = useState({});
            const [loading, setLoading] = useState(true);
            const [activeDay, setActiveDay] = useState(() => {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                const today = new Date().getDay();
                return today >= 1 && today <= 5 ? days[today-1] : 'monday';
            });
            const [teacherSubject, setTeacherSubject] = useState('');

            useEffect(() => {
                fetchTeacherTimetable();
            }, []);

            const fetchTeacherTimetable = async () => {
                try {
                    setLoading(true);
                    const teacherId = localStorage.getItem('teacherId') || 'T001';
                    const teacherData = await fetchFromFirebase(`teachers/${teacherId}`);
                    setTeacherSubject(teacherData?.subject || '');
                    localStorage.setItem('teacherSubject', teacherData?.subject || '');
                    
                    if (teacherData && teacherData.classes && teacherData.classes.length > 0) {
                        const firstClass = teacherData.classes[0];
                        const classData = await fetchFromFirebase(`classes/${firstClass}`) || {};
                        
                        if (classData.timetable) {
                            setTimetable(classData.timetable);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching timetable:', error);
                } finally {
                    setLoading(false);
                }
            };

            const days = [
                { id: 'monday', label: 'Monday' },
                { id: 'tuesday', label: 'Tuesday' },
                { id: 'wednesday', label: 'Wednesday' },
                { id: 'thursday', label: 'Thursday' },
                { id: 'friday', label: 'Friday' }
            ];

            return (
                <div className="w-full bg-white mobile-container flex flex-col">
                    <PageHeader title="Teaching Schedule" onBack={() => onNavigate('dashboard')} />
                    <main className="flex-1 p-6 overflow-y-auto bg-gray-50">
                        {loading ? (
                            <LoadingSpinner />
                        ) : Object.keys(timetable).length > 0 ? (
                            <>
                                <div className="mb-6 flex overflow-x-auto pb-2 scrollbar-hide">
                                    {days.map(day => (
                                        <button
                                            key={day.id}
                                            onClick={() => setActiveDay(day.id)}
                                            className={`px-4 py-2 rounded-full mr-2 whitespace-nowrap text-sm font-medium ${activeDay === day.id ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                                        >
                                            {day.label}
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                                    <div className="bg-gray-50 p-4 border-b">
                                        <h3 className="font-semibold text-gray-800 text-center">{days.find(d => d.id === activeDay)?.label}'s Schedule</h3>
                                    </div>
                                    <div className="divide-y divide-gray-200">
                                        {timetable[activeDay] && timetable[activeDay].length > 0 ? (
                                            timetable[activeDay].map((subject, index) => {
                                                const isMyClass = subject === teacherSubject;
                                                return (
                                                    <div key={index} className={`p-4 flex items-center ${isMyClass ? 'bg-blue-50' : ''}`}>
                                                        <div className={`w-8 h-8 rounded-full ${isMyClass ? 'bg-blue-100' : 'bg-gray-100'} flex items-center justify-center mr-3`}>
                                                            <span className={`font-bold text-sm ${isMyClass ? 'text-blue-600' : 'text-gray-600'}`}>{index + 1}</span>
                                                        </div>
                                                        <div>
                                                            <p className={`font-medium ${isMyClass ? 'text-blue-700' : 'text-gray-800'}`}>{subject}</p>
                                                            <p className="text-xs text-gray-500">Period {index + 1}</p>
                                                        </div>
                                                    </div>
                                                )
                                            })
                                        ) : (
                                            <div className="p-4 text-center text-gray-500">
                                                No classes scheduled for this day.
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="text-center py-6 text-gray-500">
                                <i data-lucide="calendar-x" className="w-12 h-12 mx-auto text-gray-400"></i>
                                <p className="mt-2">Timetable not available.</p>
                            </div>
                        )}
                    </main>
                    <AppFooter activePage={currentPage} onNavigate={onNavigate} />
                </div>
            );
        };

        //==================================
        // THE MAIN APP CONTROLLER
        //==================================
        const App = () => {
            const [currentPage, setCurrentPage] = useState({ page: 'dashboard', props: {} });
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            
            useEffect(() => {
                const teacherId = localStorage.getItem('teacherId');
                if (!teacherId) { 
                    console.log("No teacher found, redirecting to login");
                    window.location.href = 'index.html'; 
                } else { 
                    console.log("Teacher authenticated, proceeding to app");
                    setIsAuthenticated(true); 
                }
            }, []);
            
            const navigate = (page, props = {}) => {
                setCurrentPage({ page, props });
            };
            
            if (!isAuthenticated) { 
                return (
                    <div className="w-full h-screen flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
             }
            
            const renderPage = () => {
                const { page, props } = currentPage;
                
                switch(page) {
                    case 'dashboard': 
                        return <DashboardPage onNavigate={navigate} currentPage={page} />;
                    case 'profile': 
                        return <ProfilePage onNavigate={navigate} />;
                    case 'classes': 
                        return <ClassesPage onNavigate={navigate} currentPage={page} />;
                    case 'classRoster':
                        return <ClassRosterPage onNavigate={navigate} classCode={props.classCode} />;
                    case 'attendance': 
                        return <AttendancePage onNavigate={navigate} currentPage={page} classCode={props.classCode} />;
                    case 'markAttendance':
                        return <MarkAttendancePage onNavigate={navigate} classCode={props.classCode} />;
                    case 'homework': 
                        return <HomeworkPage onNavigate={navigate} currentPage={page} classCode={props.classCode} />;
                    case 'timetable': 
                        return <TimetablePage onNavigate={navigate} currentPage={page} />;
                    default: 
                        return <DashboardPage onNavigate={navigate} currentPage="dashboard" />;
                }
            };
            return ( <div>{renderPage()}</div> );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>